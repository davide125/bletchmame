# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: [ master, qt_port ]
  pull_request:
    branches: [ master, qt_port ]

# Defaults
defaults:
  run:
    shell: bash
    
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: windows-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:

    # Install PanDoc
    - name: Install PanDoc
      run: choco install pandoc
      
    # Checks out your repository under $GITHUB_WORKSPACE, so your job can access it
    - name: Checkout Repository
      uses: actions/checkout@v2

    # Checkout Dependent Repository (libexpat)
    - name: Checkout Dependent Repository (libexpat)
      uses: actions/checkout@v2
      with:
        repository: libexpat/libexpat.git
        ref: R_2_2_9
        path: deps/libexpat

    # Install Qt
    - name: Install Qt
      uses: jurplel/install-qt-action@v2
      with:
        version: '5.15.1'
        arch: 'win64_mingw81'

    # Build libexpat
    - name: Build libexpat
      run: |
        cmake deps/libexpat/expat -G "MinGW Makefiles" -B deps/libexpat_build -DEXPAT_SHARED_LIBS=OFF
        cd deps/libexpat_build
        mingw32-make -j 8

    # Build BletchMAME
    - name: Build BletchMAME
      run: |
        cmake . -G "MinGW Makefiles" -DEXPAT_LIBRARY=./deps/libexpat_build/libexpat.a -DEXPAT_INCLUDE_DIR=./deps/libexpat/expat/lib
        mingw32-make -j 8

    # Run Acceptance Tests
    - name: Run Acceptance Tests
      run: ./BletchMAME_tests.exe

    # Install PanDoc
    - name: Install PanDoc
      run: choco install pandoc      

    # Generate readme.html
    - name: Generate readme.html
      run: pandoc README.md -o readme.html

    # Build MSI
    - name: Build MSI
      run: |
        candle -v bletchmame.wxs -dVERSION=`cat obj/mingw_win64/release/version.txt` -out bletchmame.wixobj
        light -v -ext WixUIExtension bletchmame.wixobj -out BletchMAME.msi
